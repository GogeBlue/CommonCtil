# 代码规范 V0.3.0

## 一、综述

为规范项目结构和代码格式，提高代码可读性，减少错误，特制定此代码规范。所有此项目的贡献者需严格遵守此代码规范。

注释格式参考[Doxygen格式](https://www.doxygen.nl/manual/commands.html)。

## 二、项目信息

项目名称：CommonCtil

项目简称：cmt

主要编程语言：C, Assembly

系统兼容性要求：Windows, Linux

位数兼容性要求：x86/x64

编译器：msvc (Windows), gcc (others)

汇编器：nasm

## 三、文件格式

### （一）命名

#### 1. 模板

`cmt<name>[_<os>][_<arch>].(c|h|asm)`

#### 2. 字段解释

name：名字，自己选，尽量贴合文件的作用/内容；

os：操作系统

#### 3. 例子

`cmtCore.h`

`cmtCore_w_ia32.c`

`cmtCore_w_amd64.asm`

### （二）字符集/字符编码

UTF-8

## 四、C语言代码格式

### （一）源文件

#### 1. 注释

```c
/**
* @file cmtAaaa.c（此文件的名字）
* @date YYYY-MM-DD（最后修改年月日）
* @author contributor1（贡献者的名字，白嫖注明出处） <email@example.com>（邮箱）
* @author contributor2（如果有多个贡献者，就多写几行）
*/
```

要求：写在文件开头。

例：

```c
/**
* @file cmtCore_w_ia32.c
* @date 2021-07-15
* @author Dexnab
* @author Gogeblue <rex@mail.leafwolf.net>
*/
```

### （二）头文件

#### 1. 注释

```c
/**
* @file cmtAaaa.h（此文件的名字）
* @brief 功能描述
* @date YYYY-MM-DD（最后修改年月日）
* @author contributor1（贡献者的名字，白嫖注明出处） <email@example.com>（邮箱）
* @author contributor2（如果有多个贡献者，就多写几行）
*/
```

要求：写在文件开头。

例：

```c
/**
* @file cmtCore.h
* @brief 用于支持跨平台的核心库
* @date 2021-07-15
* @author Dexnab
* @author Gogeblue <rex@mail.leafwolf.net>
*/
```

#### 2. 防止重包含

在开头（文件注释后面）写：

```c
#pragma once
#ifndef _INC_CMTAAAA
#define _INC_CMTAAAA
```

其中CMTAAAA为该模块的模块名（就是文件名去掉扩展名），全部大写。

### （三）普通函数

#### 1. 命名

定义（写在.c文件里）：

```c
cmtUint8 cmtAaaaBbbb(cmtUint64 param);
```

实现（写在.h文件里）：

```c
cmtUint8 cmtAaaaBbbb(cmtUint64 param)
{
	return 0;
}
```

要求：cmt为前缀；使用驼峰命名法。

例：

```c
cmtUint8 cmtU8toU16(cmtU8str* u8, cmtU16str* u16);
cmtUint8 cmtReadJsonObj(cmtU8str* str);
```

#### 2. 注释

```c
/**
* @brief 描述
* @param[in] 输入参数 解释
* @param[out] 输出参数 解释
* @return 返回值意义
* @retval 返回值 描述
* @exception 错误码 异常描述
* @attention 注意事项
* @note 提示
* @test 测试函数 状态：PA（状态码）
* @date YYYY-MM-DD（最后修改年月日）
* @author contributor1（贡献者的名字，白嫖注明出处） <email@example.com>（邮箱）
* @author contributor2（如果有多个贡献者，就多写几行）
*/
```

例：

```c
/**
* @brief utf-8字符串转utf-16字符串
* @param[in] utf8 utf-8字符串
* @param[out] utf16 utf-16字符串
* @return 错误码
* @exception 0x00 正常
* @exception 0x10 参数错误
* @exception 0x21 内存不足
* @attention 前置条件：首字节必为头字节
* @test cmtDemoU8() 状态：PA
* @date 2021-07-02
* @author Dexnab
*/
cmtUint8 cmtU82U16(cmtU8str* utf8, cmtU16str* utf16);
```

### （四）测试函数

#### 1. 命名

测试函数定义和声明格式与普通函数相同，但注意名称要以cmtDemo开头。

例：

```c
void cmtDemoStrToF32();
```

#### 2. 注释

```c
/**
* @brief 描述
* @see 被测试的函数
* @date YYYY-MM-DD（最后修改年月日）
* @author contributor1（贡献者的名字，白嫖注明出处） <email@example.com>（邮箱）
* @author contributor2（如果有多个贡献者，就多写几行）
*/
```

例：

```c
/**
* @brief 字符串转32位浮点
* @see cmtStrToF32(cmtU8str*, float*)
* @date 2021-12-04
* @author dexnab
*/
void cmtDemoStrToF32();
```

### （五）结构体

#### 1. 命名

```c
typedef struct _CMTAAAA
{
    //...
}cmtAaaa;
```

要求：使用typedef为结构体起别名，其中cmtAaaa为日常使用中的结构体名字，_CMTAAAA为下划线+cmtAaaa全部大写。

#### 2. 注释

```c
/**
* @typedef cmtAaaa
* @brief 描述
* @date YYYY-MM-DD（最后修改年月日）
* @author contributor1（贡献者的名字，白嫖注明出处） <email@example.com>（邮箱）
* @author contributor2（如果有多个贡献者，就多写几行）
*/
/**
* @brief 描述
* @date YYYY-MM-DD（最后修改年月日）
* @author contributor1（贡献者的名字，白嫖注明出处） <email@example.com>（邮箱）
* @author contributor2（如果有多个贡献者，就多写几行）
*/
typedef struct _CMTAAAA
{
    cmtUint32 member1;///<description（解释此字段）
    cmtUint32 member2;///<description（解释此字段）
}cmtAaaa;
```

例：

```c
/**
* @typedef cmtANSIstr
* @brief ANSI字符串结构体
* @date 2021-9-23
* @author dexnab
*/
/**
* @struct _CMTANSISTR
* @brief ANSI字符串结构体
* @date 2021-9-23
* @author dexnab
*/
typedef struct _CMTANSISTR
{
	cmtChar* data;///<字符数组
	cmtUint64 size;///<总字节数
	cmtChar* locale;///<使用的代码页（locale字符串注意以\\0结尾）
}cmtANSIstr;
```

### （六）变量

#### 1. 普通变量命名

短名称：

```c
cmtUint32 sum;
cmtChar* str;
```

要求：全部小写，只包含一个单词或缩写。

长名称：

 ```c
 cmtUint32 NumberOfProcess;
 ```

要求：每个单词首字母大写。

注意：单词尽量不使用复数形式；函数参数的声明也遵循上面的规则。

### （七）宏定义

#### 1. 命名

普通宏：

```c
#define CMT_AAAA_BBBB
```

AAAA和BBBB为不同的单词或缩写，中间用下划线隔开，全部大写。

防止多重包含宏按照本规范第三章第二节第三条命名。

例：

```c
#define CMT_ENV_WINDOWS
```

#### 2. 注释

```c
/**
* @def CMT_AAAA_BBBB
* @brief 描述
* @date YYYY-MM-DD（最后修改年月日）
* @author contributor1（贡献者的名字，白嫖注明出处） <email@example.com>（邮箱）
* @author contributor2（如果有多个贡献者，就多写几行）
*/
```

例：

```c
/**
* @def CMT_ENV_WINDOWS
* @brief 如果被定义，代表系统环境为Windows环境
* @date 2021-09-14
* @author dexnab
*/
#define CMT_ENV_WINDOWS
```

### （八）typedef

#### 1. 命名

要求：cmt为前缀；使用驼峰命名法。

#### 2. 注释

```c
/**
* @typedef cmtAaaa
* @brief 描述
* @date YYYY-MM-DD（最后修改年月日）
* @author contributor1（贡献者的名字，白嫖注明出处） <email@example.com>（邮箱）
* @author contributor2（如果有多个贡献者，就多写几行）
*/
```

例：

```c
/**
* @typedef cmtUint32
* @brief 32位无符号整数类型
* @date 2021-09-14
* @author dexnab
*/
typedef unsigned long cmtUint32;
```

## 四、汇编语言代码格式

### （一）源文件

#### 1. 注释

``` assembly
; 功能描述
```

例：

``` assembly
; cmtCore实现（Intel x86架构，MASM汇编器）
```

### （二）函数

#### 1. 注释

``` assembly
; 函数声明
; 堆栈/参数寄存器信息
```

例：

``` assembly
; void cmtSpinLockEnter(cmtUint8* value, cmtUint64 MaxSpin)
; ecx = value
; edx = MaxSpin
@cmtSpinLockEnter@8 proc
; implemention not shown
@cmtSpinLockEnter@8 endp
```

#### 2. 标签

``` assembly
<函数简称>_<标签名称>:
```

例：

``` assembly
@cmtSpinLockEnter@8 proc
; implemention not shown
cSLE_SpinStart:
; implemention not shown
@cmtSpinLockEnter@8 endp
```

## 五、错误处理

### （一）错误码返回方式

|                                 | 两种错误码（错和没错）             | 多种错误码                      |
| ------------------------------- | ---------------------------------- | ------------------------------- |
| **本身无需返回值**              | 返回cmtBool，错为TRUE，没错为FALSE | 返回cmtUint8，值为错误码        |
| **本身需要返回值（不会返回0）** | 发生错误返回0，没错返回正常返回值  | 追加cmtUint8* err参数传递错误码 |
| **本身需要返回值（会返回0）**   | 追加cmtUint8* err参数传递错误码    | 追加cmtUint8* err参数传递错误码 |

### （二）错误码定义范围

所有函数均可自由定义自己的错误码，但错误码范围应遵守以下规范：

| 范围        | 用途                                                         |
| ----------- | ------------------------------------------------------------ |
| {0x00}      | 正常，无任何错误                                             |
| [0x01,0x0f] | 无严重错误，但部分功能未实现                                 |
| {0x10}      | 参数错误                                                     |
| [0x11,0x1f] | 详细分类的参数错误（如参数不能为0，输出参数缓冲区不够，第几个参数错了） |
| {0x20}      | 内存错误                                                     |
| [0x21,0x2f] | 详细分类的内存错误（如内存不足，读写冲突等）                 |
| [0x30,0xef] | 自定义                                                       |
| [0xf0,0xff] | 错误（不详细分类）                                           |

## 六、项目注意事项

### （一）目录

/release：发布版本（包括调试版本）

/src：本项目的源代码和头文件（如果要使用本库，请用/release/xxx/inc文件夹里的头文件）

/pt3：第三方库文件夹

/demo：示例代码文件夹

/doc：说明文档文件夹

/licenses：协议文件

/build：（此文件夹不会被git add）所有不需要commit的文件，如vs工程文件

Makefile：makefile

LICENCE：licence

